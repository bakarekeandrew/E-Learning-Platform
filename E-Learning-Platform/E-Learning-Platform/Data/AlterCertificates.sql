-- Check if columns exist before adding them
IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE object_id = OBJECT_ID('CERTIFICATES') AND name = 'COMPLETION_DATE')
BEGIN
    ALTER TABLE CERTIFICATES
    ADD COMPLETION_DATE DATETIME NULL;
END

IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE object_id = OBJECT_ID('CERTIFICATES') AND name = 'CERTIFICATE_NUMBER')
BEGIN
    ALTER TABLE CERTIFICATES
    ADD CERTIFICATE_NUMBER NVARCHAR(50) NULL;
END

-- Update existing records with default values
UPDATE CERTIFICATES
SET COMPLETION_DATE = ISSUE_DATE
WHERE COMPLETION_DATE IS NULL;

UPDATE CERTIFICATES
SET CERTIFICATE_NUMBER = CONCAT('CERT-', FORMAT(ISSUE_DATE, 'yyyyMMdd'), '-', USER_ID, '-', COURSE_ID)
WHERE CERTIFICATE_NUMBER IS NULL;

-- Now make the columns NOT NULL since we've populated them
IF EXISTS (SELECT 1 FROM sys.columns WHERE object_id = OBJECT_ID('CERTIFICATES') AND name = 'COMPLETION_DATE')
BEGIN
    ALTER TABLE CERTIFICATES
    ALTER COLUMN COMPLETION_DATE DATETIME NOT NULL;
END

IF EXISTS (SELECT 1 FROM sys.columns WHERE object_id = OBJECT_ID('CERTIFICATES') AND name = 'CERTIFICATE_NUMBER')
BEGIN
    ALTER TABLE CERTIFICATES
    ALTER COLUMN CERTIFICATE_NUMBER NVARCHAR(50) NOT NULL;
END

-- Add unique constraint for CERTIFICATE_NUMBER if it doesn't exist
IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'UQ_CERTIFICATE_NUMBER' AND object_id = OBJECT_ID('CERTIFICATES'))
BEGIN
    ALTER TABLE CERTIFICATES
    ADD CONSTRAINT UQ_CERTIFICATE_NUMBER UNIQUE (CERTIFICATE_NUMBER);
END

-- Add index for faster lookups if it doesn't exist
IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_CERTIFICATES_NUMBER' AND object_id = OBJECT_ID('CERTIFICATES'))
BEGIN
    CREATE INDEX IX_CERTIFICATES_NUMBER ON CERTIFICATES(CERTIFICATE_NUMBER);
END

-- Print completion message
PRINT 'Database update completed successfully.'; 